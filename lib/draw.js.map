{"version":3,"file":"draw.js","sources":["../src/event/drawEvent.js","../src/style/toolStyle.js","../src/style/addStyle.js","../src/style/baseStyle.js","../src/tools/state/toolState.js","../src/tools/extends/rubber/rubber.js","../src/tools/extends/clear/clear.js","../src/tools/extends/paint/paint.js","../src/tools/extends/index.js","../src/tools/index.js","../src/main.js"],"sourcesContent":["// 绘制事件\r\nexport default class DrawEvent {\r\n  constructor(cavansEl, ctx) {\r\n    this.cavans = cavansEl;\r\n    this.ctx = ctx;\r\n    // 是否正在绘制中\r\n    this.painting = false;\r\n    // 保存上一次的绘制点位\r\n    this.lastPoint = { x: undefined, y: undefined };\r\n    this.initDrawEvent();\r\n    // 事件池\r\n    this.eventHookPool = {};\r\n  }\r\n  initDrawEvent() {\r\n    const canvas = this.cavans;\r\n    const ctx = this.ctx;\r\n    const vm = this;\r\n    //鼠标按下事件\r\n    canvas.onmousedown = function (e) {\r\n      this.painting = true;\r\n      let x = e.clientX;\r\n      let y = e.clientY;\r\n      this.lastPoint = { x: x, y: y };\r\n      drawCircle(ctx, x, y, 2);\r\n      vm.emitEventHook('mousedown');\r\n    };\r\n\r\n    //鼠标移动事件\r\n    canvas.onmousemove = function (e) {\r\n      if (this.painting) {\r\n        let x = e.clientX;\r\n        let y = e.clientY;\r\n        let newPoint = { x: x, y: y };\r\n        vm.drawLine(this.lastPoint.x, this.lastPoint.y, newPoint.x, newPoint.y);\r\n        this.lastPoint = newPoint;\r\n      }\r\n      vm.emitEventHook('mousemove');\r\n    };\r\n\r\n    //鼠标松开事件\r\n    canvas.onmouseup = function () {\r\n      this.painting = false;\r\n      vm.emitEventHook('mouseup');\r\n    };\r\n  }\r\n  // 注册新的绘制中事件\r\n  appendEventHook(event, callback) {\r\n    if (this.eventHookPool[event]) {\r\n      this.eventHookPool[event].push(callback);\r\n    } else {\r\n      this.eventHookPool[event] = [callback];\r\n    }\r\n  }\r\n  // 熔断钩子，执行对应的事件\r\n  emitEventHook(event, ...params) {\r\n    if (this.eventHookPool[event]) {\r\n      return this.eventHookPool[event].every((cb) => {\r\n        return cb.call(this, ...params);\r\n      });\r\n    }\r\n  }\r\n  // 绘制线条\r\n  drawLine(x1, y1, x2, y2) {\r\n    // 初始化线条，之后会做抽离\r\n    this.ctx.lineWidth = 3;\r\n    this.ctx.lineCap = 'round';\r\n    this.ctx.lineJoin = 'round';\r\n    // 利用熔断决定是否之后后续的绘制\r\n    if (!this.emitEventHook('drawline', x1, y1, x2, y2)) {\r\n      return;\r\n    }\r\n    this.ctx.moveTo(x1, y1);\r\n    this.ctx.lineTo(x2, y2);\r\n    this.ctx.stroke();\r\n    this.ctx.closePath();\r\n  }\r\n}\r\n\r\n// 绘制像素点\r\nfunction drawCircle(ctx, x, y, radius) {\r\n  ctx.save();\r\n  ctx.beginPath();\r\n  ctx.arc(x, y, radius, 0, Math.PI * 2);\r\n  ctx.fill();\r\n}\r\n","export const toolUiStyleSheet = {\r\n  position: 'absolute',\r\n  boxSizing: 'border-box',\r\n  top: 0,\r\n  right: 0,\r\n  display: 'flex',\r\n  justifyContent: 'space-between',\r\n  width: '300px',\r\n  padding: '20px',\r\n  height: '100vh',\r\n  background: '#888',\r\n};\r\n","// 给节点添加CSS属性\r\nexport function addStyle(el, styleSheet) {\r\n  Object.keys(styleSheet).forEach((key) => {\r\n    el.style[key] = styleSheet[key];\r\n  });\r\n}\r\n","export const BaseButtonStyleSheet = {\r\n  width: '60px',\r\n  lineHeight: '30px',\r\n  height: '30px',\r\n  background: 'white',\r\n  textAlign: 'center',\r\n  borderRadius: '6px',\r\n  cursor: 'default',\r\n};\r\n","// 目前仅考虑各种状态互斥的情况，之后可以考虑添加到多种状态共存\r\n// 工具栏状态管理工具\r\nclass ToolState {\r\n  constructor() {\r\n    this.statePool = {};\r\n    this.stateCopy = {};\r\n  }\r\n  addState(name, initValue) {\r\n    if (this.statePool[name]) {\r\n      return;\r\n    }\r\n    this.statePool[name] = initValue;\r\n    this.stateCopy[name] = initValue;\r\n  }\r\n  initState() {\r\n    Object.keys(this.stateCopy).forEach((key) => {\r\n      this.statePool[key] = this.stateCopy[key];\r\n    });\r\n  }\r\n  setState(name, value) {\r\n    this.initState();\r\n    this.statePool[name] = value;\r\n  }\r\n  getState(name) {\r\n    return this.statePool[name];\r\n  }\r\n}\r\n\r\nexport default new ToolState();\r\n","import { addStyle } from '../../../style/addStyle';\r\nimport { BaseButtonStyleSheet } from '../../../style/baseStyle';\r\nimport statePool from '../../state/toolState';\r\n// 注册新的工具状态\r\nstatePool.addState('isRubber', false);\r\n// 橡皮檫工具\r\nexport default {\r\n  /*  */\r\n  registered(vm) {\r\n    // 初始化UI\r\n    const buttton = document.createElement('div');\r\n    buttton.innerHTML = `橡皮`;\r\n    addStyle(buttton, BaseButtonStyleSheet);\r\n    const ctx = vm.ctx;\r\n    const canvas = vm.el;\r\n    const callBack = function (x1, y1, x2, y2) {\r\n      if (statePool.getState('isRubber')) {\r\n        // 利用canvas的裁剪实现擦除功能\r\n        ctx.save();\r\n        ctx.globalCompositeOperation = 'destination-out';\r\n        ctx.moveTo(x1, y1);\r\n        ctx.lineTo(x2, y2);\r\n        ctx.stroke();\r\n        ctx.closePath();\r\n        ctx.clip();\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n        ctx.restore();\r\n        return false;\r\n      }\r\n      return true;\r\n    };\r\n    // 添加到绘制事件中的钩子上\r\n    vm.drawEvent.appendEventHook('drawline', callBack);\r\n    vm.drawEvent.appendEventHook('mousedown', callBack);\r\n    // 添加点击事件，更改工具状态\r\n    buttton.onclick = function () {\r\n      statePool.setState('isRubber', true);\r\n    };\r\n    return buttton;\r\n  },\r\n};\r\n","import { addStyle } from '../../../style/addStyle';\r\nimport { BaseButtonStyleSheet } from '../../../style/baseStyle';\r\n// 清除工具\r\nexport default {\r\n  registered(vm) {\r\n    const buttton = document.createElement('div');\r\n    buttton.innerHTML = `清除`;\r\n    addStyle(buttton, BaseButtonStyleSheet);\r\n    buttton.onclick = function () {\r\n      const canvas = vm.el;\r\n      vm.ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n    };\r\n    return buttton;\r\n  },\r\n};\r\n","import { addStyle } from '../../../style/addStyle';\r\nimport { BaseButtonStyleSheet } from '../../../style/baseStyle';\r\nimport statePool from '../../state/toolState';\r\n// 画笔工具\r\nexport default {\r\n  registered(vm) {\r\n    const buttton = document.createElement('div');\r\n    buttton.innerHTML = `画笔`;\r\n    addStyle(buttton, BaseButtonStyleSheet);\r\n    buttton.onclick = function () {\r\n      statePool.initState();\r\n    };\r\n    return buttton;\r\n  },\r\n};\r\n","import rubber from './rubber/rubber';\r\nimport clear from './clear/clear';\r\nimport paint from './paint/paint';\r\n// 所有默认插件，之后需要对位置进行配置化处理\r\nexport default {\r\n  paint,\r\n  rubber,\r\n  clear,\r\n};\r\n","import { toolUiStyleSheet } from '../style/toolStyle';\r\nimport { addStyle } from '../style/addStyle';\r\nimport defaultExtends from './extends/index';\r\n// 工具栏\r\n// 这里使用扩展机制，利用扩展将各个工具进行解耦\r\nexport default class Tools {\r\n  constructor(root, vm) {\r\n    this.root = root;\r\n    this.extendsList = [];\r\n    this.registerExtend(vm);\r\n    this.toolUi = document.createElement('div');\r\n    addStyle(this.toolUi, toolUiStyleSheet);\r\n    this.render();\r\n  }\r\n  render() {\r\n    this.extendsList.forEach((extend) => {\r\n      this.toolUi.appendChild(extend);\r\n    });\r\n    this.root.appendChild(this.toolUi);\r\n  }\r\n  // 注册所有默认的功能扩展\r\n  registerExtend(vm) {\r\n    Object.keys(defaultExtends).forEach((extend) => {\r\n      this.extendsList.push(defaultExtends[extend].registered(vm));\r\n    });\r\n  }\r\n}\r\n","import DrawBoard from './board/index';\r\nimport DrawEvent from './event/drawEvent';\r\nimport Tools from './tools/index';\r\nexport default class Draw {\r\n  constructor(options) {\r\n    this.options = options;\r\n    this.root = null;\r\n    this.el = null;\r\n    this.ctx = null;\r\n    this.tools = null;\r\n    this.drawEvent = null;\r\n    this.initCtx();\r\n    this.initDrawBoard();\r\n    this.initDrawEvent();\r\n    this.initTools();\r\n  }\r\n  // 初始化上下文\r\n  initCtx() {\r\n    const ElName = this.options.el;\r\n    this.root = document.querySelector(ElName);\r\n    this.el = document.createElement('canvas');\r\n    this.root.appendChild(this.el);\r\n    this.ctx = this.el.getContext('2d');\r\n    let pageWidth = document.documentElement.clientWidth;\r\n    let pageHeight = document.documentElement.clientHeight;\r\n    this.el.width = pageWidth;\r\n    this.el.height = pageHeight;\r\n  }\r\n  // 初始化画板，之后需要在这里处理鼠标和画面的偏移问题\r\n  initDrawBoard() {\r\n    // this.drawBoard = new DrawBoard(this.options);\r\n  }\r\n  // 初始化绘制事件\r\n  initDrawEvent() {\r\n    this.drawEvent = new DrawEvent(this.el, this.ctx);\r\n  }\r\n  // 初始化工具栏\r\n  initTools() {\r\n    this.tools = new Tools(this.root, this);\r\n  }\r\n}\r\n"],"names":["DrawEvent","cavansEl","ctx","canvas","vm","e","x","y","drawCircle","newPoint","event","callback","params","cb","x1","y1","x2","y2","radius","toolUiStyleSheet","addStyle","el","styleSheet","key","BaseButtonStyleSheet","ToolState","name","initValue","value","statePool","rubber","buttton","callBack","clear","paint","defaultExtends","Tools","root","extend","Draw","options","ElName","pageWidth","pageHeight"],"mappings":"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"}